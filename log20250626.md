# 研仪联工程师APP开发日志

## 版本 0.1.0 - 2025-06-25 09点47分

### 修复内容
1. 修复了任务创建页面的图片上传功能
   - 创建了必要的上传目录 `D:/uploads/task/images`
   - 修改了前端的图片上传逻辑，先上传图片再创建任务
   - 修改了后端的图片上传方法，增加了错误处理和日志记录
   - 修复了静态资源访问配置，确保上传的图片可以被正确访问

2. 修复了任务创建功能
   - 调整了前端提交的数据结构，将设备信息从嵌套对象改为平铺字段
   - 确保前后端字段名称一致，避免数据丢失

### 改进内容
1. 增强了错误处理和日志记录
2. 优化了文件上传路径配置
3. 添加了对上传文件的代理配置

### 下一步计划
1. 完善任务详情页面
2. 优化任务列表展示
3. 实现任务状态流转功能

## 版本 0.1.1 - 2025-06-25 10点05分

### 修复内容
1. 修复了创建任务页面的日期格式问题，解决了任务创建失败问题
   - 添加了日期工具类，统一处理日期格式转换
   - 修改了前端任务数据构建方法，确保发送正确格式的日期
   - 增强了前后端日期处理的兼容性

2. 增强了错误处理和日志记录
   - 添加了详细的日志配置
   - 改进了异常处理和错误信息展示
   - 增加了请求体日志记录，方便调试

3. 添加了Jackson配置，优化日期时间序列化和反序列化
   - 创建专门的Jackson配置类
   - 添加了JSR310模块依赖
   - 统一了日期时间格式

### 改进内容
1. 代码质量优化
2. 日志记录增强
3. 错误处理改进

### 下一步计划
1. 完善任务详情页面
2. 优化任务列表展示
3. 实现任务状态流转功能

## 版本 0.1.2 - 2025-06-25 11点35分

### 修复内容
1. 解决创建任务提交失败问题
   - 创建了专门的JacksonConfig配置类处理日期格式问题
   - 添加了多种日期格式兼容处理
   - 修复了LocalDateTime与Date类型转换问题

2. 修复任务列表显示问题
   - 解决了任务状态显示错误问题
   - 优化了日期时间显示格式
   - 添加了分页处理

### 改进内容
1. 任务创建流程优化
2. 添加了请求参数验证
3. 完善了错误处理机制

### 下一步计划
1. 完善任务详情页面
2. 实现任务步骤流程管理
3. 优化用户界面体验

## 版本 0.1.3 - 2025-06-25 15点24分

### 修复内容
1. 修复任务详情页的上一步和下一步功能
   - 完善了TaskController中的updateTaskFlowStatus接口实现
   - 增加了详细的日志记录，帮助排查问题
   - 重构了TaskServiceImpl中的updateTaskFlowStatus方法，确保正确处理任务状态
   - 修复了前端TaskDetail.vue中的taskId参数错误

2. 解决useDraggable容器尺寸问题
   - 为底部导航按钮容器设置了明确的尺寸
   - 添加了width和min-height属性，确保容器有正确的尺寸

### 改进内容
1. 增强了错误处理和日志记录
2. 改进了任务流程状态更新逻辑
3. 优化了前端UI布局，解决了控制台错误

### 下一步计划
1. 继续优化任务流程管理
2. 实现任务评价功能
3. 优化设备信息管理

## 版本 0.1.4 - 2025-06-25 11点07分

### 修复内容
1. 解决任务创建时数据库插入失败问题
   - 修改Task实体类中的@TableId注解，添加type = IdType.AUTO属性
   - 修改TaskEngineer实体类中的@TableId注解，添加type = IdType.AUTO属性
   - 解决SQL Server不能为自增列插入显式值的问题

2. 优化日期时间处理
   - 删除WebMvcConfig中冲突的LocalDateTime配置
   - 优化JacksonConfig配置，确保支持前端ISO格式的日期

### 改进内容
1. 实体类主键生成策略更加规范
2. 避免了数据库ID冲突问题
3. 统一了日期时间处理机制

### 下一步计划
1. 继续优化任务创建流程
2. 完善任务状态流转功能
3. 实现任务详情页面

## 版本 0.1.5 - 2025-06-25 11点11分

### 修复内容
1. 解决任务步骤(TaskStep)创建失败问题
   - 修改TaskStep实体类中的@TableId注解，添加type = IdType.AUTO属性
   - 修改TaskImage实体类中的@TableId注解，添加type = IdType.AUTO属性
   - 彻底解决SQL Server不能为自增列插入显式值的问题

2. 全面检查实体类主键生成策略
   - 检查了所有使用@TableName注解的实体类
   - 确认所有带有@TableId注解的实体类都配置了正确的type属性

### 改进内容
1. 统一了实体类主键生成策略
2. 避免了任务创建过程中的数据库错误
3. 增强了系统稳定性

### 下一步计划
1. 优化任务创建和修改流程
2. 完善任务详情页面功能
3. 实现任务状态变更通知机制

## 版本 0.1.6 - 2025-06-25 11点17分

### 修复内容
1. 修改保存草稿功能的实现方式
   - 将原有的API请求保存草稿改为使用localStorage本地存储
   - 修改saveAsDraft方法，使其将表单数据保存到浏览器本地存储
   - 防止了400错误的发生，符合用户期望的本地保存功能

2. 添加草稿自动加载功能
   - 添加loadDraftFromLocalStorage方法，实现草稿数据的自动加载
   - 进入创建任务页面时自动检查并加载本地存储的草稿数据
   - 提供清除草稿的选项，使用户可以选择是否继续使用草稿

3. 优化草稿管理功能
   - 添加clearLocalDraft方法，实现草稿数据的清除
   - 在成功创建任务后自动清除本地草稿，避免数据残留
   - 提供草稿加载提示，让用户知道当前正在使用草稿数据

### 改进内容
1. 任务创建体验优化
2. 表单数据保留机制改进
3. 用户交互流程更加符合预期

### 下一步计划
1. 优化草稿数据的图片处理
2. 增加草稿过期自动清理功能
3. 完善任务详情页面功能

## 版本 0.1.7 - 2025-06-25 16点30分

### 修复内容
1. 修复任务详情页面客户设备加载失败问题
   - 验证CustomerMapper.xml中的selectCustomerDevices方法SQL实现
   - 问题可能是MyBatis缓存导致，应用重启后可解决

2. 修复ConfirmDialog组件警告问题
   - 增加对customContent属性的定义，支持Function、Boolean和null类型
   - 修改emits定义，增加对close事件的支持
   - 添加closeDialog方法，统一处理关闭对话框的逻辑

3. 修复任务步骤上一步和下一步按钮API调用问题
   - 修改updateTaskStep函数，使用taskflow.js中定义的API
   - 修改completeTaskStep函数，确保使用正确的参数格式
   - 保证API调用方式一致性

### 改进内容
1. 组件警告消息消除
2. API调用格式统一化
3. 代码结构更加规范
4. 用户交互更加流畅

### 下一步计划
1. 继续完善任务详情页面功能
2. 优化任务状态流转逻辑
3. 增强前后端数据一致性 

## 版本 0.1.8 - 2025-06-26 09点30分

### 实现内容
1. 完成任务详情页上一步和下一步功能
   - 创建了TaskFlowStatusRequest类接收前端请求数据
   - 在TaskController中添加了/flow/status接口端点
   - 在TaskService中实现了updateTaskFlowStatus方法
   - 完善了任务步骤状态更新的业务逻辑

2. 优化前端上一步和下一步实现
   - 修复了前端API调用中的taskId参数错误
   - 重构了prevStep和nextStep方法，确保正确处理索引值
   - 删除了冗余的updateTaskStep方法
   - 添加了错误处理和状态恢复机制

3. 增强步骤状态管理逻辑
   - 根据不同操作类型（update/complete/skip）实现对应逻辑
   - 自动更新步骤的开始时间和结束时间
   - 确保当前步骤在数据库中正确更新
   - 处理步骤状态转换（pending -> in-progress -> completed）

### 改进内容
1. 用户体验优化：实现了任务详情页底部的上一步和下一步按钮功能
2. 代码质量提升：更加规范的API实现和错误处理
3. 业务逻辑完善：正确处理任务流程状态变更
4. 前后端交互改进：完整的API调用链路和数据一致性

### 下一步计划
1. 实现任务详情页其他功能点（如任务转出、协作工程师等）
2. 增加任务步骤变更的历史记录和审计日志
3. 优化任务流程UI体验 

## 版本 0.1.9 - 2025-06-26 16点45分

### 修复内容
1. 修复任务详情页面的工作记录表单取消按钮无法正常工作的问题
   - 修改了TaskDetail.vue中的事件监听名称，从`@close`改为`@cancel`，使其与TaskStepRecordForm.vue组件中定义的事件名称匹配
   - 更新了TaskDetail.vue中TaskStepRecordForm组件的属性传递，将`stepIndex`替换为`stepId`和`stepName`，确保传递正确的参数
   - 修复了表单属性不匹配问题，移除了不需要的`editingRecordIndex`和`initialRecord`属性

### 改进内容
1. 增强了组件间事件通信的一致性
2. 确保组件属性传递的正确性
3. 提高用户体验，使取消按钮能够正常工作

### 下一步计划
1. 继续完善任务详情页面功能
2. 优化工作记录的展示和管理
3. 增强系统稳定性和用户体验 

## 0.3.2 - 修复任务详情页步骤显示和导航功能

## 0.3.3 - 2024-07-10 16点30分

### 修复内容
1. 修复客户列表查询功能中SQL Server数据库错误
   - 修改了CustomerMapper.xml中的查询方法，解决SQL Server中子查询使用ORDER BY的问题
   - 添加了专门的countAllCustomers方法替代原来的countCustomers方法
   - 修改了CustomerServiceImpl中的分页查询实现，使用单独的计数查询获取总记录数
   - 更新了PageHelper配置，添加了sqlServerWithNoOrderByTopQuery参数

2. 优化分页查询实现
   - 避免使用PageHelper自动计数功能，改为手动查询总记录数
   - 优化了分页结果构建逻辑，使用更简洁的代码

### 改进内容
1. 解决了"获取客户列表失败"的错误
2. 提高了SQL Server数据库查询的兼容性
3. 优化了分页查询性能
4. 增强了系统稳定性

### 下一步计划
1. 继续完善联系人和客户管理功能
2. 优化数据库查询效率
3. 增强系统整体稳定性

### 问题描述
任务详情页存在步骤显示问题，同时上一步/下一步按钮点击后不会更新显示状态与后端数据库对应步骤。

### 解决方案
实现了一个混合方案，结合了以下几种技术：
1. 使用Pinia状态管理 - 创建专门的taskFlow store集中管理任务流程状态
2. 乐观更新策略 - 在用户操作后立即更新UI，提供即时反馈
3. 优化API响应处理 - 确保前后端数据一致性
4. 轻量级事件通知系统 - 实现组件间的松耦合通信

### 具体修改
1. 创建了新的状态管理文件：
   - `ryl-engineer-app/src/stores/taskFlow.js` - 任务流程状态管理
   - `ryl-engineer-app/src/utils/eventBus.js` - 轻量级事件总线

2. 修改了以下文件：
   - `ryl-engineer-app/src/views/task/TaskDetail.vue` - 使用Pinia store替代直接API调用
   - `ryl-engineer-app/src/components/task/detail/TaskFlowController.vue` - 使用Pinia store和事件总线

3. 主要功能改进：
   - 实现了步骤状态的即时更新
   - 添加了错误处理和回滚机制
   - 优化了组件间的数据同步
   - 提供了更好的用户反馈

### 技术细节
- 使用Vue 3的Composition API和Pinia进行状态管理
- 实现了基于事件的组件通信机制
- 采用乐观更新策略提升用户体验
- 保持前后端数据一致性 

## 0.3.3 - 2024-06-25 修复任务上门决策功能

### 问题描述
任务详情页面中"判断是否需要上门"步骤的按钮（需要上门/线上协助）点击后报404错误，无法正常处理上门决策。

### 修复内容
1. 在后端TaskController中添加了`/{taskId}/decide-visit`接口，用于处理上门决策请求
2. 在TaskService接口中添加了`updateTaskSiteVisitDecision`方法
3. 在TaskServiceImpl中实现了`updateTaskSiteVisitDecision`方法，完成以下功能：
   - 更新任务的needSiteVisit字段
   - 将当前步骤标记为已完成
   - 确定下一步骤（如果需要上门，进入下一步；如果不需要上门，跳到服务评价步骤）
   - 更新任务的当前步骤
   - 将下一步骤标记为进行中
4. 在前端taskflow.js中增加日志输出，方便调试

### 影响范围
此修复影响任务详情页面中的上门决策功能，使工程师能够正常选择是否需要上门服务。 

## 0.3.4 - 2025-06-25 修复提交记录和任务转出功能

### 问题描述
1. 提交工作记录时报错：ReferenceError: addTaskFlowRecord is not defined
2. 任务转出功能未实现，点击"申请转出任务"按钮无响应

### 修复内容
1. 修复提交记录功能：
   - 在TaskDetail.vue中导入addTaskFlowRecord函数
   - 修改submitRecord函数，正确构建记录数据并调用API

2. 实现任务转出功能：
   - 在后端TaskController中添加`/{taskId}/transfer`接口
   - 在TaskService接口中添加transferTask方法
   - 在TaskServiceImpl中实现transferTask方法
   - 创建TaskActivity和TaskTransferHistory实体类及相关Mapper
   - 实现完整的任务转出逻辑，包括：
     - 更新任务负责人
     - 记录转出历史
     - 添加任务动态记录

### 影响范围
此修复影响任务详情页面的工作记录提交功能和任务转出功能，使工程师能够正常提交工作记录和将任务转交给其他工程师。 

## 项目更新日志

## 0.3.4 (2023-06-25)

### 修复
- 修复了任务详情页面提交工作记录功能报错的问题（ReferenceError: addTaskFlowRecord is not defined）
- 修复了任务详情页面客户信息卡片没有显示简略客户信息的问题
- 实现了任务转出功能，包括前后端完整支持

### 新增
- 添加了TaskActivity实体类和相关Mapper，用于记录任务活动
- 添加了TaskTransferHistory实体类和相关Mapper，用于记录任务转出历史
- 添加了任务转出API接口（POST /api/v1/tasks/{taskId}/transfer）

### 改进
- 优化了客户信息卡片的显示效果，增加了客户简略信息展示
- 优化了工作记录提交功能，提升了用户体验 

## 版本 0.3.3 (2025-06-25)

### 更新内容
1. 修复任务状态管理问题：
   - 添加了后端API端点`/api/v1/tasks/{taskId}/status`用于任务状态更新
   - 创建了TaskStatusHistory实体类和相关Mapper用于记录任务状态变更历史
   - 实现了在步骤变更时自动更新任务状态的功能
   - 优化了UI显示，确保任务状态变更后界面及时更新

2. UI改进：
   - 删除了TaskBaseInfoCard组件中的进度条UI
   - 优化了TaskStatusCard组件样式，增强了状态显示
   - 改进了状态历史记录的显示格式

### 修复Bug
- 修复任务状态更新后UI不更新的问题
- 修复状态更改API 404错误，添加了正确的后端端点 

## 0.1.0 (2024-07-10)

### 联系人页面模块更新

- 添加"其它联系人"标签页，显示除工程师外的其他角色用户
- 修改客户管理功能，实现基于角色的权限控制
- 添加客户删除确认密码功能
- 创建工程师-客户关系表和相关代码
- 实现客户列表按角色筛选API
- 优化联系人页面导航和交互
- 完善客户数据管理相关API
- 建立客户与工程师、销售人员的关联关系数据结构 

## 0.1.1 (2024-07-10)

### 联系人页面模块API交互完善

- 修复联系人页面API访问实现，确保前后端字段和数据格式一致
- 优化ContactsServiceImpl中的convertToContactDTO方法，正确处理用户信息映射
- 修复OtherContacts.vue中的字段名和API调用方式
- 添加联系人详情页路由和组件交互
- 完善API分页参数处理和错误处理
- 增强联系人搜索功能
- 优化UI交互和样式效果
- 添加了联系人相关的API函数
- 确保前端组件正确地消费API返回的数据 