# 开发日志

## 2024-05-29 车辆打卡记录功能开发

### 后端开发内容

1. 创建车辆打卡记录相关实体类和DTO：
   - `VehicleRecord.java`：车辆打卡记录实体类
   - `VehicleRecordRequest.java`：打卡记录请求DTO
   - `VehicleRecordResponse.java`：打卡记录响应DTO
   - `VehicleRecordStatsResponse.java`：打卡统计响应DTO

2. 创建车辆打卡记录相关Mapper：
   - `VehicleRecordMapper.java`：打卡记录Mapper接口
   - `VehicleRecordMapper.xml`：打卡记录Mapper XML实现

3. 创建车辆打卡记录相关服务：
   - `VehicleRecordService.java`：打卡记录服务接口
   - `VehicleRecordServiceImpl.java`：打卡记录服务实现类

4. 创建车辆打卡记录控制器：
   - `VehicleRecordController.java`：提供打卡记录相关API接口

5. 数据库表创建：
   - `V2__create_vehicle_record_table.sql`：创建车辆打卡记录表及示例数据

6. 增强JWT工具类：
   - 在`JwtUtil.java`中添加`getUserId`方法，用于从token中获取用户ID

### 前端开发内容

1. 创建车辆打卡记录相关API：
   - `vehicleRecord.js`：提供打卡记录相关API调用方法

2. 创建车辆打卡记录相关Store：
   - `vehicleRecord.js`：管理打卡记录相关状态

3. 更新视图组件：
   - `Location.vue`：更新打卡功能，使用新创建的vehicleRecord store
   - `ProfileVehicle.vue`：更新打卡记录列表，使用新创建的vehicleRecord store

### API接口说明

1. 创建打卡记录：`POST /api/v1/vehicle-record`
2. 根据ID获取打卡记录：`GET /api/v1/vehicle-record/{id}`
3. 获取当前用户的打卡记录列表：`GET /api/v1/vehicle-record/my-records`
4. 根据任务ID获取打卡记录列表：`GET /api/v1/vehicle-record/task/{taskId}`
5. 获取指定时间范围内的打卡记录列表：`GET /api/v1/vehicle-record/time-range`
6. 获取指定月份的打卡统计信息：`GET /api/v1/vehicle-record/stats/month`
7. 获取当月的打卡统计信息：`GET /api/v1/vehicle-record/stats/current-month`

### 功能说明

1. 打卡类型：
   - 1: 出发打卡
   - 2: 到达打卡
   - 3: 返程打卡

2. 打卡流程：
   - 工程师在任务开始前进行出发打卡
   - 到达客户现场后进行到达打卡
   - 任务完成后进行返程打卡

3. 打卡记录统计：
   - 按月统计打卡次数、任务数、总里程
   - 在个人中心展示打卡记录列表

## 2024-05-30 功能优化和UI调整

### 前端更新内容

1. 个人信息模块：
   - 确保所属部门下拉菜单包含3个部门选项：工程师、仓库管理员、客户经理

2. 车辆信息页面：
   - 移除车辆信息页面中的打卡记录功能，简化界面

3. 打卡功能增强：
   - 在位置打卡页面添加交通工具选择功能，包括三个选项：公车、私车、公共交通
   - 要求用户必须选择交通工具才能进行打卡操作

4. UI优化：
   - 调整底部按钮的位置，使用`env(safe-area-inset-bottom)`确保按钮不被导航栏遮挡
   - 优化移动端适配，提升用户体验

### 后端更新内容

1. 实体类更新：
   - 在`VehicleRecord`实体类中添加`transportType`字段，表示交通工具类型

2. DTO更新：
   - 在`VehicleRecordRequest`中添加`transportType`字段，作为必填项
   - 在`VehicleRecordResponse`中添加`transportType`和`transportTypeName`字段

3. 数据库更新：
   - 在`vehicle_record`表中添加`transport_type`字段
   - 更新示例数据，添加交通工具类型信息

4. 服务层更新：
   - 在`VehicleRecordServiceImpl`中添加对交通工具类型的处理逻辑
   - 添加`getTransportTypeNameByCode`方法，用于将交通工具类型代码转换为名称

5. 数据库更新：
   - 在`vehicle_info`表中更新车辆类型枚举值，移除"租车"选项
   - 更新相关代码以适应新的车辆类型限制

6. 服务层更新：
   - 修改`VehicleService`中的验证逻辑，确保只接受"公车"或"私车"类型
   - 更新相关文档和API描述

## 2024-05-31 界面优化和问题修复

### 前端更新内容

1. 车辆信息页面优化：
   - 完全移除车辆信息页面(`VehicleInfo.vue`)中的打卡记录入口
   - 简化界面，提高用户体验

2. UI布局问题修复：
   - 修复底部按钮被导航栏遮挡的问题
   - 增加底部安全区域填充至70px
   - 提高底部操作栏的z-index值至100，确保在最上层显示
   - 优化移动端适配，确保在各种设备上正常显示

## 2024-06-01 UI问题修复

### 前端更新内容

1. 修复上门定位打卡记录页面底部按钮问题：
   - 进一步增加`ProfileVehicle.vue`中底部按钮的安全区域填充至90px
   - 提高z-index值至1000，确保按钮显示在最上层
   - 为按钮添加40px的底部边距，防止被导航栏遮挡
   - 解决在不同设备上底部按钮被导航栏覆盖的问题

2. 优化了打卡页面（Location.vue）的底部按钮位置
   - 将底部按钮上移至距底部70px的位置，避免被导航栏遮挡
   - 增加页面底部padding至120px，确保内容完全可见
   - 设置z-index为100，确保按钮始终显示在最上层

这些调整确保了在不同设备上打卡按钮都能正常显示和使用，不会被底部导航栏遮挡。

## 2024-06-02

### 前端更新内容

1. 优化了打卡界面（Location.vue）的任务信息选择功能：
   - 将任务信息改为可选形式，用户可从下拉列表中选择现有任务
   - 添加了"其他"选项，允许用户输入自定义任务信息
   - 实现了任务选择变化时的数据联动更新

2. 改进了交通工具选择功能：
   - 当选择公车或私车时，显示对应类型的车辆下拉列表
   - 用户必须选择具体车辆才能进行打卡
   - 公共交通选项保持不变

3. 增强了打卡验证逻辑：
   - 添加了`isReadyForCheckIn`计算属性，综合判断是否满足打卡条件
   - 打卡时根据选择的任务（预设或自定义）提交相应数据
   - 添加了车辆ID字段，记录使用的具体车辆信息

4. 修改了车辆信息页面的车辆类型选项：
   - 移除了"租车"选项，仅保留"公车"和"私车"两个选项
   - 简化了用户的车辆类型选择

这些更新使打卡功能更加灵活，支持用户选择不同任务和车辆进行打卡，同时保证了数据的完整性和准确性。

## 2024-06-03

### 前端更新内容

1. 优化了打卡界面（Location.vue）的打卡类型选择功能：
   - 新增打卡类型选择区域，包含三个选项：出发打卡、上门打卡、回程打卡
   - 用户可以直接选择打卡类型，而不再由系统根据已有记录自动判断
   - 打卡类型成为必选项，确保用户明确知晓当前的打卡行为

2. 增强了打卡验证逻辑：
   - 更新`isReadyForCheckIn`计算属性，添加对打卡类型的检查
   - 打卡时直接使用用户选择的打卡类型，提高数据准确性
   - 优化了表单验证逻辑，提供更清晰的用户反馈

3. 界面交互优化：
   - 为打卡类型选项添加图标和视觉反馈
   - 保持与交通工具选择区域一致的设计风格
   - 确保在各种设备上的显示效果一致

这些更新使打卡功能更加直观和用户友好，让用户可以明确选择打卡类型，减少操作错误。

## 版本 0.4.0 - 2025年06月13日

### UI界面重新设计
- 重新设计了Home.vue，改进了基于角色的任务过滤功能
- 更新了任务过滤器UI和交互
- 新增了高级筛选面板，支持按任务类型、时间范围、优先级和工程师筛选
- 重新设计了任务卡片样式
- 根据用户角色控制创建任务按钮的显示

### 任务详情页改进
- 完全重新设计了TaskDetail.vue的UI界面
- 添加了任务状态横幅和状态切换功能
- 改进了任务基本信息的展示方式，增加了任务类型和优先级徽章
- 添加了更直观的任务进度条
- 重新组织了设备信息和需求信息的展示
- 使用时间轴样式展示任务流程步骤
- 改进了步骤的展开/折叠功能
- 优化了记录和附件的显示方式
- 更新了协作工程师部分，支持空状态显示
- 增加了协作工程师的统计信息
- 重新设计了底部操作栏，根据角色和任务状态显示不同操作按钮

### 权限控制
- 更新了基于角色的功能访问控制
- 管理员可以查看和操作所有任务
- 工程师只能查看和操作自己的任务
- 客户经理只能查看与自己客户相关的任务
- 仓库管理员可以查看任务但没有操作权限

### 代码优化
- 使用计算属性进行角色判断，提高代码可维护性
- 优化了样式结构，增加了模块化CSS
- 添加了状态转换函数，简化业务逻辑
- 改进了加载和错误状态的处理

### 其他改进
- 为空数据状态添加了友好的提示和操作建议
- 添加了联系客户的快捷功能
- 支持生成任务报告功能
- 改进了移动设备上的响应式布局 

## 版本 0.4.1 - 2025年06月25日

### 全新联系人管理模块
- 创建了新的联系人主页面，替换原有的工程师状态一览页面
- 重构联系人功能为两个子模块：工程师状态和客户管理
- 在底部导航栏中更新了图标，由"工程师"改为"联系人"

### 工程师状态功能增强
- 重新设计了工程师状态页面，按工作地点分组显示工程师信息
- 增加了可收起/展开的分组功能，支持泰州、苏州、武汉、四川等地区
- 设计支持自动从数据库添加新工作地点，无需修改UI界面
- 优化了工程师状态的筛选功能，支持按忙碌状态筛选

### 客户管理权限控制
- 根据角色权限控制客户列表的可见范围：
  - 管理员可查看所有客户
  - 工程师只能查看与自己任务相关的客户
  - 销售/客户经理只能查看自己负责的客户
- 添加了客户可视范围提示信息，提高用户体验
- 优化了客户列表的UI设计和交互

### 全新仓库管理模块设计
- 重新设计仓库主页面，改为按地点分类的入口导航
- 创建了仓库详情页面，支持泰州仓、苏州仓、武汉仓、四川仓等
- 每个仓库支持四种物品类型：配件库、仪器库、耗材库、固定资产
- 优化了物品卡片的显示，采用更紧凑的布局，提高信息密度
- 设计支持自动添加新仓库地点，实现扩展性

### 物品详情页面
- 新增物品详情页面，支持查看完整的物品信息
- 添加了出入库记录展示和管理功能
- 支持物品入库和出库操作
- 优化了移动端上的显示效果 