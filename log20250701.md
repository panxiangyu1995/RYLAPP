# 研仪联工程师APP项目开发日志

## 版本 0.3.7 - 2025年07月01日 08:27

### 修改内容
1. 实现了工程师状态API功能
   - 修改前端API调用函数，移除分页参数，使用不分页方式获取工程师列表
   - 在后端ContactsController中添加了`getEngineerStatusList`方法，处理`/api/v1/contacts/engineers`请求
   - 在ContactsService接口中添加了`getEngineerStatusByLocation`方法声明
   - 在ContactsServiceImpl中实现了`getEngineerStatusByLocation`方法，直接查询工程师信息并按location分组
   - 从任务表获取工程师任务数量和当前任务信息，根据任务数量判断工程师状态
   - 修改EngineerStatus.vue页面，连接到真实API，替换模拟数据，添加错误处理

### 实现经验
1. 工程师状态API开发经验：
   - 按工作地点分组的数据结构设计：后端返回Map<String, List<Map<String, Object>>>格式数据，前端解析后按位置分组显示
   - 任务数量与状态判断：根据未完成任务数量（0=可协助，1-2=部分可协，3+=忙碌）自动判断工程师状态
   - 使用JdbcTemplate直接执行SQL查询，避免复杂的ORM映射，提高查询效率
   - 前端使用watch监听筛选条件变化，实时更新数据

2. 前后端数据一致性处理：
   - 后端返回数据格式与前端期望格式保持一致，减少前端转换逻辑
   - 使用默认值处理可能为空的字段，如avatar、department、currentTask等
   - 统一使用驼峰命名法，确保字段名称一致性
   - 添加日志记录，方便调试和问题排查

3. 性能优化考虑：
   - 不使用分页，直接获取全部工程师数据，适用于工程师数量不大的场景
   - 使用单次SQL查询获取工程师基本信息和任务信息，减少数据库查询次数
   - 按工作地点预先分组，减少前端处理逻辑
   - 默认展开所有分组，提升用户体验

## 版本 0.3.6 - 2025年07月01日 17:30

### 修改内容
1. 修复了消息中心聊天会话列表获取错误问题
   - 修正了ChatConversationMapper.xml中的SQL查询条件，将status = 1改为status = 'active'，与数据库表中的实际值保持一致
   - 修正了SQL Server不支持LIMIT关键字的问题，将LIMIT 1替换为TOP 1

### 修复问题的经验
1. SQL查询条件与数据库实际值匹配问题：
   - 确保SQL查询条件中的字符串值使用引号包裹
   - 检查数据库表结构中的实际字段值类型和默认值
   - 在SQL Server中，字符串类型的字段值比较需要使用引号
   
2. 数据库方言差异处理：
   - SQL Server不支持MySQL/PostgreSQL的LIMIT语法，需要使用TOP关键字
   - 在跨数据库开发时，需要注意SQL语法的兼容性问题

3. 前端数据显示问题排查方法：
   - 检查API请求和响应数据
   - 分析数据库中的示例数据是否与当前登录用户相关
   - 利用console.log输出关键数据点进行调试

## 版本 0.3.5 - 2025年07月01日 16:30

### 修改内容
1. 修复了消息中心模块的数据获取错误问题
   - 修正了ChatConversation实体类属性映射问题，将 `property="type"` 改为 `property="conversationType"`
   - 修正了参数名不一致的问题，将SQL中的 `#{type}` 替换为 `#{conversationType}`
   - 修正了ChatConversation相关的taskId属性，将 `property="taskId"` 改为 `property="relatedTaskId"`，并将参数 `#{taskId}` 改为 `#{relatedTaskId}`
   - 移除了AnnouncementReadMapper.xml中对不存在的 `create_time` 列的所有引用
   - 修改了AnnouncementRead实体类，移除了不存在的 `createTime` 属性
   - 修改了AnnouncementServiceImpl.java，移除了对已删除的 `setCreateTime()` 方法的调用

### 修复问题的经验
1. MyBatis实体映射问题排查技巧：
   - 仔细比对实体类的属性名与Mapper XML文件中的property名称
   - 确保数据库表结构与实体类定义一致
   - 检查insert语句中的参数名是否与实体类属性名匹配
   - 通过错误堆栈和数据库错误信息定位具体问题

2. 数据库表字段与实体类属性不一致的处理方法：
   - 要么调整实体类以适应数据库结构
   - 要么调整数据库以适应代码
   - 或者使用注解/映射配置建立起正确的关联关系
   - 始终优先选择最小修改方案，避免引入更多问题

3. 在团队开发中处理架构不一致问题：
   - 及时进行代码审查，确保代码质量和一致性
   - 建立开发规范，统一命名和映射关系
   - 编写全面的单元测试，在早期发现潜在问题
   - 善用版本控制系统，跟踪重要修改

## 版本 0.1.0 - 2025年06月30日 10:02

### 修改内容
1. 修复了消息详情页二次获取数据的问题
   - 在Messages.vue组件中修改了viewMessageDetail方法，添加消息数据传递功能
   - 在MessageDetail.vue组件中增加formatMessageFromPassed方法，使其优先使用传递的消息数据
   - 消息列表页面获取到的消息数据直接传递给详情页，避免了二次请求API

### 修复问题的经验
1. 消息流程最佳实践：
   - 数据获取应遵循"一次获取、多处使用"的原则，减少重复请求
   - 页面间数据传递应通过路由query参数或state管理工具(如Pinia)进行
   - 详情页优先使用传递的数据，只在没有数据时才发起API请求
   - 对象数据转为JSON字符串传递时，注意处理可能的解析错误

2. Vue路由数据传递注意事项：
   - 通过query参数传递大量数据可能导致URL过长，建议限制数据量
   - 使用try-catch处理JSON解析可能的错误，确保健壮性
   - 数据传递与展示要保持分离，格式化展示数据应在目标组件内进行

## 版本 0.0.6 - 2025年06月26日 11:24

### 修改内容
1. 彻底解决了SQL Server中子查询ORDER BY语法错误问题
   - 在所有查询方法中使用了SELECT TOP 100 PERCENT语句替代include片段引用
   - 直接在SQL中展开完整的查询语句，避免使用子查询
   - 保留ORDER BY子句在最外层查询中

### 修复问题的经验
1. SQL Server对子查询中的ORDER BY有严格限制，必须与TOP、OFFSET或FOR XML一起使用
2. 使用TOP 100 PERCENT是一种有效的解决方案，可以让SQL Server接受子查询中的ORDER BY子句
3. 在使用PageHelper进行分页查询时，应避免在子查询中使用ORDER BY子句
4. 当遇到SQL Server特定的语法限制时，有时直接展开SQL语句比使用SQL片段更有效
5. 修改SQL查询时，应该全面考虑数据库引擎的特定语法要求和分页插件的工作原理

## 版本 0.0.5 - 2025年06月26日 11:07

### 修改内容
1. 修复了PageHelper分页查询的SQL转换错误问题
   - 从CustomerMapper.xml的selectCustomerWithSalesJoin片段中移除了ORDER BY子句和OFFSET 0 ROWS
   - 将ORDER BY子句移到了各个查询方法的末尾
   - 这样避免了在子查询中使用ORDER BY导致的PageHelper转换错误

### 修复问题的经验
1. PageHelper在处理带有ORDER BY和OFFSET的子查询时可能会报"不支持该SQL转换为分页查询"错误
2. 在使用PageHelper进行分页查询时，应避免在SQL片段中包含ORDER BY子句，而应在最外层查询中添加ORDER BY
3. SQL Server对子查询中的ORDER BY有严格限制，但在最外层查询中使用ORDER BY是没有问题的
4. 使用MyBatis的SQL片段时，应该保持片段的简单性，避免在片段中包含可能导致语法错误的复杂语句

## 版本 0.0.4 - 2025年06月26日 11:01

### 修改内容
1. 彻底修复了SQL Server中子查询ORDER BY语法错误问题
   - 在CustomerMapper.xml的selectCustomerWithSalesJoin片段中添加了`OFFSET 0 ROWS`
   - 这符合SQL Server语法要求，子查询中使用ORDER BY必须同时使用TOP、OFFSET或FOR XML
   - 移除了各查询方法中多余的ORDER BY子句，避免重复排序

2. 整合了重复的客户管理组件
   - 确认CustomerManagement.vue已在路由中使用，位于/contacts/customers路径
   - CustomerList.vue组件未被路由使用，保留作为参考

### 修复问题的经验
1. SQL Server对子查询中的ORDER BY有严格限制，必须与TOP、OFFSET或FOR XML一起使用
2. 使用`OFFSET 0 ROWS`是一种简洁的解决方案，不会影响查询结果
3. 前端组件应避免功能重复，确保路由指向正确的组件
4. 修改SQL查询时，应考虑数据库引擎的特定语法要求

## 版本 0.0.3 - 2025年06月26日 10:51

### 修改内容
1. 修复了CustomerMapper.xml中的SQL语法错误问题
   - 在selectAllCustomersPage、selectCustomersBySalesId和selectCustomersByIds方法中移除了多余的SELECT TOP 100 PERCENT语句
   - 直接使用include标签引入SQL片段，避免SELECT关键字重复

### 修复问题的经验
1. 在MyBatis中使用include标签引入SQL片段时，如果该片段本身已经包含了完整的SELECT语句，则外部不应再包含SELECT关键字
2. SQL Server对SQL语法的要求比较严格，不允许在同一查询中重复使用SELECT关键字
3. 修改SQL映射文件时，应确保SQL语法符合特定数据库的要求，避免语法错误

## 版本 0.0.2 - 2025年06月26日 08:57

### 修改内容
1. 修复了客户列表页面的SQL错误问题
   - 在CustomerMapper.xml中添加了TOP 100 PERCENT关键字，解决SQL Server中子查询ORDER BY的限制问题
   - 在CustomerServiceImpl.java中移除了PageHelper.orderBy()方法调用

### 修复问题的经验
1. SQL Server在子查询中使用ORDER BY子句时，必须同时指定TOP、OFFSET或FOR XML，这是SQL Server的特定语法要求
2. 使用PageHelper进行分页查询时，不应该同时使用PageHelper.orderBy()方法和SQL中的ORDER BY子句，这会导致PageHelper无法正确处理分页查询
3. 对于SQL Server数据库，在子查询中使用ORDER BY时，可以添加TOP 100 PERCENT关键字来满足语法要求

### 前端报错问题
1. 前端useDraggable错误（Container for initialSnapArea has zero width or height）属于第三方库的正常行为，根据错误信息中的提示："Those two errors are expected! (Everything is fine, they are part of stagewise's discovery mechanism!)"，这是预期的行为，不需要修复。

## 版本 0.0.1 - 2025年06月26日 08:47

### 修改内容
1. 修复了客户列表页面的SQL错误问题
   - 在CustomerServiceImpl.java中添加了PageHelper.orderBy("c.create_time DESC")方法调用
   - 在CustomerMapper.xml中移除了SQL查询中的ORDER BY子句

### 修复问题的经验
1. SQL Server在子查询中使用ORDER BY子句时，必须同时指定TOP、OFFSET或FOR XML，这是SQL Server的特定语法要求
2. 使用PageHelper进行分页查询时，可以通过PageHelper.orderBy()方法设置排序，而不需要在SQL语句中添加ORDER BY子句
3. 修改前应仔细检查数据库类型和特定的语法要求，避免类似问题

### 前端报错问题
1. 前端useDraggable错误（Container for initialSnapArea has zero width or height）属于第三方库的正常行为，根据错误信息中的提示："Those two errors are expected! (Everything is fine, they are part of stagewise's discovery mechanism!)"，这是预期的行为，不需要修复。

## 版本0.0.7 - 2025-06-26

### 修改内容
1. 修复客户管理页面分页查询报错问题
   - 错误信息：`不支持该SQL转换为分页查询!`
   - 原因：SQL Server对子查询中的ORDER BY有严格限制，必须与TOP、OFFSET或FOR XML一起使用
   - 解决方案：
     - 在CustomerServiceImpl.java中使用PageHelper.startPage(page, size, "c.create_time DESC")指定排序
     - 从CustomerMapper.xml中移除所有查询方法中的ORDER BY子句
     - 这样让PageHelper在生成分页SQL时直接添加排序，避免在子查询中使用ORDER BY

### 经验总结
1. SQL Server分页查询注意事项：
   - SQL Server中子查询不能直接使用ORDER BY，会导致语法错误
   - 使用PageHelper进行分页时，可以直接在startPage方法中指定排序字段，而不是在SQL中指定
   - 对于复杂查询，建议使用"TOP 100 PERCENT"语法确保SQL Server接受排序
   - 如果使用了ORDER BY，确保它在最外层查询中，而不是子查询中

2. PageHelper在SQL Server环境下的优化：
   - 避免在XML中编写ORDER BY子句，而是通过PageHelper.startPage方法的第三个参数提供
   - 确保application.yml中正确配置了PageHelper的方言为sqlserver
   - 对于复杂查询，考虑使用手写count查询

## 版本0.0.8 - 2025-06-26

### 修改内容
1. 进一步修复客户管理页面分页查询报错问题
   - 错误信息：`不支持该SQL转换为分页查询!`仍然存在
   - 解决方案：
     - 修改PageHelper配置，添加更多SQL Server特定配置参数
     - 完全重写CustomerMapper.xml中的查询方法，不再使用include片段和TOP 100 PERCENT
     - 直接展开SQL查询，避免子查询和复杂的SQL结构

### 经验总结
1. SQL Server分页查询进阶解决方案：
   - 避免使用SQL片段（include）和子查询，直接展开完整查询
   - 在PageHelper配置中添加更多SQL Server特定参数：
     ```yaml
     pagehelper:
       helperDialect: sqlserver
       reasonable: true
       supportMethodsArguments: true
       params: count=countSql
       autoRuntimeDialect: true
       sqlServerWithNoOrderByTopQuery: true
       countSuffix: _COUNT
       dialectAlias: sqlserver=com.github.pagehelper.dialect.helper.SqlServerDialect
       offsetAsPageNum: true
     ```
   - 简化SQL查询结构，避免嵌套子查询和复杂的WHERE条件

## 版本0.0.9 - 2025-06-26

### 修改内容
1. 彻底修复客户管理页面分页查询报错问题
   - 完全放弃使用PageHelper，改为手动实现分页
   - 修改CustomerServiceImpl.java：
     - 移除所有PageHelper相关代码
     - 手动计算偏移量和添加分页参数到查询参数中
   - 修改CustomerMapper.xml：
     - 在SQL查询中直接使用OFFSET FETCH语法实现分页
     - 动态添加ORDER BY子句

### 经验总结
1. SQL Server分页查询最佳实践：
   - 在复杂查询场景下，可能需要完全放弃使用PageHelper等ORM分页工具
   - 直接使用SQL Server原生的OFFSET FETCH语法实现分页
   - 手动计算偏移量和限制数量，通过参数传递给SQL查询
   - 确保ORDER BY子句位于正确的位置（在OFFSET FETCH之前）

2. 分页查询性能优化：
   - 确保排序字段有索引
   - 尽量减少JOIN操作
   - 对于大数据量表，考虑使用分区表或其他优化技术

## 版本 0.3.3 (2025-06-30)

### 修复协助消息接口500错误

**修复内容**:
1. 修复了协助请求模块实体类与数据库表字段不匹配的问题
   - 在`AssistanceRequest.java`中添加了`@TableName`和`@TableField`注解
   - 修正了实体类中字段名与数据库表字段的映射关系
   - 添加了缺失的`requestId`字段
2. 修复了`AssistanceRequestMapper.xml`中的SQL查询问题
   - 使用`SELECT DISTINCT`替代`GROUP BY`避免SQL Server兼容性问题
3. 修复了`AssistanceRequestRecipientMapper.xml`中的SQL函数问题
   - 将MySQL风格的`NOW()`函数替换为SQL Server兼容的`GETDATE()`
4. 添加了数据库修复脚本`db-fix-script.sql`
   - 检查并修复表字段类型不匹配问题
   - 确保外键关系正确建立
   - 添加测试数据（当表为空时）
5. 前端错误处理增强
   - 在协助请求功能暂不可用时提供友好的用户提示

**修复经验**:
1. 在处理跨数据库平台项目时，需要注意不同数据库之间的函数和语法差异
2. 在对象关系映射(ORM)中，确保实体类与数据库表的映射关系正确是关键
3. 对于临时不可用的功能，应提供友好的用户提示，而不是简单地显示错误
4. 修复数据库表结构问题时，应该编写可重复执行的脚本，包含必要的条件检查

**下一步计划**:
1. 监控协助请求API的运行状态
2. 为所有API接口添加统一的错误处理机制
3. 实现协助请求功能的全面测试 

## 版本 0.3.4 (2025-06-30 20:06)

### 修复消息页面API返回500错误问题

**修复内容**:
1. 修复JWT认证机制问题
   - 完善`JwtAuthenticationInterceptor`，添加专门的认证错误处理方法
   - 对未提供token或token无效的请求返回适当的HTTP 401状态码
   - 增加公开API路径的白名单，允许无认证访问
   - 增加详细日志记录，便于问题追踪

2. 修复数据库查询问题
   - 修正`ChatConversationMapper.xml`中的status条件，将`c.status = 1`修改为`c.status = 'active'`
   - 修改`AnnouncementMapper.xml`中的`create_time`引用为`update_time`，解决列名无效的问题
   - 优化分页查询，使用SQL Server兼容的OFFSET FETCH语法
   - 完全替换XM中会导致解析错误的+号运算符语法

3. 完善Controller层错误处理
   - 为`ChatController`和`AnnouncementController`添加全面的异常处理
   - 添加用户身份验证检查，确保在处理请求前验证用户登录状态
   - 使用try-catch包装所有业务逻辑，捕获并妥善处理异常

4. 优化前端错误处理机制
   - 修改`Messages.vue`中的`fetchAllMessages`方法，使用`Promise.allSettled`处理多个API请求
   - 为每个API请求添加.catch错误处理，确保请求永远不会失败
   - 即使部分API失败，仍能显示成功获取的数据
   - 添加更友好的错误提示，告知用户哪些数据模块加载失败

**修复经验**:
1. 认证机制设计的最佳实践：
   - 认证失败时应明确返回401状态码和友好错误消息
   - 为公共访问接口设置白名单，避免不必要的认证
   - 在拦截器中清理ThreadLocal，防止内存泄漏
   - 添加详细日志记录，便于问题追踪

2. 跨数据库平台开发注意事项：
   - SQL Server和MySQL的函数和语法差异显著，需要专门适配
   - 字符串和整数类型的处理方式不同（如status字段的'active' vs 1）
   - 确保在MyBatis映射文件中使用正确的列名和类型匹配
   - 在XML中处理特殊字符（如+号）时需要特别小心

3. 前端容错设计要点：
   - 使用Promise.allSettled替代Promise.all，允许部分失败
   - 为每个独立的数据源添加单独的错误处理
   - 提供降级展示策略，在部分数据缺失时仍能提供基本功能
   - 友好的错误提示，指明具体哪个功能模块受影响

4. MyBatis与SQL Server集成的注意事项：
   - 确保实体类字段名与数据库字段名正确映射
   - 使用正确的SQL Server兼容的分页语法（OFFSET FETCH）
   - 避免在XML文件中出现可能被解析为特殊字符的操作符
   - 根据数据库定义使用匹配的字段类型（varchar vs int）

## 0.3.5 - 2025-07-01 15:33

### 修复
- 修复任务卡片中工程师显示问题
  - 问题：任务卡片显示"未分配工程师"，但API返回数据中有engineers字段
  - 原因：TaskCard.vue组件中getEngineers()方法只检查engineers字段，未考虑其他可能的工程师字段
  - 解决：扩展getEngineers()方法，增加对owner、assignedEngineer等字段的检查
  
- 移除预加载任务详情的提示
  - 问题：主页显示"已预加载4个任务详情"的提示，但这是调试功能
  - 解决：从Home.vue中移除预加载提示相关的DOM元素和逻辑，设置showCacheStatus默认为false 